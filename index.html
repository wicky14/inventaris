<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#4f46e5">
    <title>SmartStock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overflow-y: auto !important;
            transition: zoom 0.2s ease;
        }
        [x-cloak] { display: none !important; }
        
        .glass { background: rgba(79, 70, 229, 0.98); backdrop-filter: blur(16px); }
        
        header { 
            padding-top: calc(3rem + env(safe-area-inset-top)) !important; 
            padding-bottom: 1rem !important;
        }
        .safe-area-bottom { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .fab-container { filter: drop-shadow(0 10px 15px rgba(79, 70, 229, 0.3)); }

        .gpu-layer {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
            will-change: transform, opacity;
        }

        main {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: auto; 
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            padding-top: calc(7.8rem + env(safe-area-inset-top)) !important;
        }

        .tabs-wrapper {
            display: flex;
            width: 400%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            align-items: flex-start;
        }

        .tab-section {
            width: 25%;
            flex-shrink: 0;
            padding: 0 1.5rem;
            height: 0;
            overflow: hidden;
            visibility: hidden;
        }

        .tab-section.active-tab {
            height: auto;
            overflow: visible;
            visibility: visible;
        }

        .transition, [x-transition] {
            transition-duration: 150ms !important;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        #report-template {
            width: 900px;
            padding: 40px;
            background: white;
            position: absolute;
            left: -9999px;
            top: 0;
        }

        .modal-scroll-area {
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900" x-data="inventoryApp()" x-init="init()">

    <header class="fixed top-0 w-full glass z-40 border-b border-indigo-500/30 px-6 flex justify-between items-center gpu-layer">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-white">SmartStock <span class="text-[10px] bg-white text-indigo-600 px-2 py-0.5 rounded-full ml-1">V1</span></h1>
            <p class="text-[10px] text-indigo-100 font-bold uppercase tracking-widest" x-text="currentTab"></p>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-[10px] font-mono font-bold text-indigo-100 bg-indigo-700/50 px-2 py-1 rounded">Next: <span class="text-white" x-text="generatePreview()"></span></span>
        </div>
    </header>

    <div class="fixed bottom-28 right-6 z-50 fab-container gpu-layer" x-show="['dashboard', 'barang'].includes(currentTab)" x-transition>
        <button @click="openModal = true; selectedItemId = 'new'; transactionType = 'in'; resetForms()" class="bg-indigo-600 text-white w-16 h-16 rounded-2xl shadow-2xl flex items-center justify-center active:scale-90 transition transform">
            <i class="fas fa-plus text-2xl"></i>
        </button>
    </div>

    <main class="pb-40">
        <div class="tabs-wrapper" :style="'transform: translateX(-' + (tabsOrder.indexOf(currentTab) * 25) + '%)'">
            
            <div class="tab-section" :class="currentTab === 'dashboard' ? 'active-tab' : ''">
                <div class="gpu-layer">
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="bg-indigo-600 p-6 rounded-[2.5rem] text-white shadow-xl shadow-indigo-100">
                            <p class="text-[10px] font-bold opacity-70 uppercase tracking-wider">Total Unit</p>
                            <p class="text-3xl font-black mt-1" x-text="totalStock()"></p>
                        </div>
                        <div @click="currentTab = 'barang'" class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm text-left">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Jenis Barang</p>
                            <p class="text-3xl font-black text-slate-800 mt-1" x-text="items.length"></p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-extrabold text-slate-800">Riwayat Transaksi</h2>
                        <span class="text-[10px] font-bold text-slate-400 uppercase" x-text="transactions.length + ' Total'"></span>
                    </div>
                    
                    <div class="space-y-3">
                        <template x-for="(trx, index) in transactions.slice(0, showLimit)" :key="trx.id">
                            <div class="bg-white p-4 rounded-3xl flex items-center justify-between border border-slate-50 shadow-sm">
                                <div class="flex items-center gap-4">
                                    <div :class="trx.type === 'in' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'" 
                                         class="w-12 h-12 rounded-2xl flex items-center justify-center text-lg">
                                        <i :class="trx.type === 'in' ? 'fas fa-arrow-down' : 'fas fa-arrow-up'"></i>
                                    </div>
                                    <div>
                                        <p class="font-bold text-sm text-slate-800" x-text="trx.itemName"></p>
                                        <p x-show="trx.note" class="text-[9px] text-indigo-500 font-bold italic" x-text="'&quot;' + trx.note + '&quot;'"></p>
                                        <p class="text-[10px] text-slate-400 font-medium" x-text="trx.date"></p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p :class="trx.type === 'in' ? 'text-emerald-600' : 'text-rose-600'" class="font-black text-lg" x-text="(trx.type === 'in' ? '+' : '-') + trx.qty"></p>
                                        <p class="text-[9px] font-mono text-slate-300" x-text="trx.location"></p>
                                    </div>
                                    <button @click="deleteTransaction(trx.id)" class="text-slate-300 hover:text-rose-500 p-2 transition-colors">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </template>

                        <template x-if="transactions.length > showLimit">
                            <button @click="showLimit += 10" class="w-full py-4 bg-white border border-slate-100 rounded-3xl text-indigo-600 font-bold text-xs uppercase tracking-widest shadow-sm active:scale-95 transition">
                                Tampilkan Lebih Banyak
                            </button>
                        </template>
                    </div>
                </div>
            </div>

            <div class="tab-section" :class="currentTab === 'barang' ? 'active-tab' : ''">
                <div class="gpu-layer">
                    <div class="relative mb-6">
                        <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" x-model="search" placeholder="Cari Kode, Nama, Lokasi..." 
                            class="w-full pl-14 pr-6 py-5 rounded-[2rem] bg-white border-none shadow-sm focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div class="space-y-4">
                        <template x-for="item in filteredItems" :key="item.id">
                            <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-slate-50 flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="flex gap-2 items-center mb-1">
                                        <span class="text-[9px] font-mono font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded" x-text="item.invNo"></span>
                                        <span class="text-[9px] font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded uppercase" x-text="item.location"></span>
                                    </div>
                                    <h3 class="font-bold text-slate-800 text-lg" x-text="item.name"></h3>
                                    <p class="text-sm text-slate-400 font-semibold" x-text="'Rp ' + formatNumber(item.price)"></p>
                                </div>
                                <div class="flex items-center gap-4 bg-slate-50 px-6 py-3 rounded-[1.5rem] border border-slate-100">
                                    <div class="text-center">
                                        <span class="text-[9px] font-bold text-slate-400 block leading-none mb-1">STOK</span>
                                        <span class="text-2xl font-black text-slate-700" x-text="item.stock"></span>
                                    </div>
                                    <div class="border-l border-slate-200 pl-4 ml-2">
                                        <button @click="deleteItem(item.id)" class="text-slate-300 hover:text-rose-500 transition-colors p-2">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="tab-section" :class="currentTab === 'laporan' ? 'active-tab' : ''">
                <div class="gpu-layer">
                    <h2 class="font-black text-2xl text-slate-800 mb-6">Laporan Per Bulan</h2>
                    <div class="space-y-4">
                        <template x-for="report in getMonthlyReports().slice(0, reportLimit)" :key="report.key">
                            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col gap-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-lg font-black text-slate-800" x-text="report.monthName"></p>
                                        <p class="text-xs text-slate-400 font-bold uppercase tracking-wider" x-text="report.count + ' Transaksi'"></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="previewImage(report)" class="bg-indigo-50 text-indigo-600 px-4 py-3 rounded-2xl font-bold text-sm flex items-center gap-2 active:scale-95 transition">
                                            <i class="fas fa-eye"></i> Lihat
                                        </button>
                                        <button @click="downloadMonthlyPDF(report.month, report.year, report.monthName)" class="bg-emerald-50 text-emerald-600 px-4 py-3 rounded-2xl font-bold text-sm flex items-center gap-2 active:scale-95 transition">
                                            <i class="fas fa-file-pdf"></i> PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <template x-if="getMonthlyReports().length > reportLimit">
                            <button @click="reportLimit += 12" class="w-full py-4 bg-white border border-slate-100 rounded-3xl text-indigo-600 font-bold text-xs uppercase tracking-widest shadow-sm active:scale-95 transition">
                                Tampilkan Laporan Lainnya
                            </button>
                        </template>
                    </div>
                </div>
            </div>

            <div class="tab-section" :class="currentTab === 'settings' ? 'active-tab' : ''">
                <div class="gpu-layer">
                    <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100 space-y-6">
                        <h2 class="font-black text-2xl text-slate-800">Sistem & Data</h2>
                        
                        <div class="p-5 bg-indigo-50 rounded-3xl border border-indigo-100">
                            <label class="text-[10px] font-bold text-indigo-400 uppercase ml-1">Format Prefix Kode (SKU)</label>
                            <div class="flex gap-2 mt-2">
                                <input type="text" x-model="config.prefix" @input="save()" placeholder="Contoh: SKU-2026-" 
                                    class="flex-1 p-4 bg-white rounded-xl border-none font-bold text-indigo-600 focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <p class="text-[9px] text-slate-400 mt-2 px-1">* Ubah awalan kode untuk barang baru di sini.</p>
                        </div>

                        <div class="p-5 bg-slate-50 rounded-3xl border border-slate-100">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ukuran Tampilan (Zoom)</label>
                                <span class="text-xs font-black text-indigo-600" x-text="config.zoomScale + '%'"></span>
                            </div>
                            <input type="range" min="80" max="150" step="5" x-model="config.zoomScale" @input="updateZoom()" 
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                            <div class="flex justify-between mt-1 px-1">
                                <span class="text-[8px] text-slate-400 font-bold">KECIL</span>
                                <span class="text-[8px] text-slate-400 font-bold">BESAR</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button @click="exportData()" class="flex flex-col items-center p-4 bg-indigo-50 text-indigo-600 rounded-3xl gap-2">
                                <i class="fas fa-file-download text-xl"></i>
                                <span class="text-[10px] font-bold uppercase">Export Backup</span>
                            </button>
                            <label class="flex flex-col items-center p-4 bg-slate-50 text-slate-600 rounded-3xl gap-2 cursor-pointer">
                                <i class="fas fa-file-upload text-xl"></i>
                                <span class="text-[10px] font-bold uppercase">Import Data</span>
                                <input type="file" @change="importData($event)" class="hidden" accept=".json">
                            </label>
                        </div>
                        <div class="pt-6 border-t border-slate-100">
                            <button @click="showConfirm('Reset Data?', 'Semua data akan dihapus permanen!', () => resetApp())" class="w-full p-5 text-rose-500 font-bold text-sm bg-rose-50 rounded-2xl active:bg-rose-100 transition">Reset Semua Data</button>
                            <div class="mt-6 text-center">
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Aplikasi dibuat di AGV</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-200 px-6 pt-5 pb-10 z-40 flex justify-between safe-area-bottom gpu-layer">
        <button @click="currentTab = 'dashboard'" :class="currentTab === 'dashboard' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1.5 transition-colors">
            <i class="fas fa-house-chimney text-xl"></i>
            <span class="text-[10px] font-bold tracking-wide">DASHBOARD</span>
        </button>
        <button @click="currentTab = 'barang'" :class="currentTab === 'barang' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1.5 transition-colors">
            <i class="fas fa-box-open text-xl"></i>
            <span class="text-[10px] font-bold tracking-wide">BARANG</span>
        </button>
        <button @click="currentTab = 'laporan'" :class="currentTab === 'laporan' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1.5 transition-colors">
            <i class="fas fa-chart-pie text-xl"></i>
            <span class="text-[10px] font-bold tracking-wide">LAPORAN</span>
        </button>
        <button @click="currentTab = 'settings'" :class="currentTab === 'settings' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1.5 transition-colors">
            <i class="fas fa-sliders text-xl"></i>
            <span class="text-[10px] font-bold tracking-wide">SETTINGS</span>
        </button>
    </nav>

    <div x-show="showImagePreview" x-cloak class="fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" @click="showImagePreview = false"></div>
        <div class="relative bg-white w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="font-black text-lg">Pratinjau Laporan</h3>
                <button @click="showImagePreview = false" class="text-slate-400"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-slate-100">
                <img :src="previewImageData" class="w-full shadow-lg rounded-lg border border-slate-200" x-show="previewImageData">
                <div x-show="!previewImageData" class="flex flex-col items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-500 border-t-transparent"></div>
                    <p class="mt-4 font-bold text-slate-500">Menyiapkan Gambar...</p>
                </div>
            </div>
            <div class="p-6 bg-white flex gap-3">
                <button @click="downloadPNG()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> Download PNG
                </button>
            </div>
        </div>
    </div>

    <div id="report-template" x-ref="reportTemplate">
        <div class="border-b-4 border-indigo-600 pb-6 mb-6 flex justify-between items-end">
            <div>
                <h1 class="text-4xl font-black text-indigo-600">SMARTSTOCK</h1>
                <p class="text-slate-400 font-bold">Laporan Inventaris Digital Otomatis</p>
            </div>
            <div class="text-right">
                <p class="text-xs font-bold text-slate-400 uppercase">Periode Laporan</p>
                <p class="text-2xl font-black text-slate-800" x-text="activeReportName"></p>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-sm font-black text-slate-800 mb-4 bg-slate-100 p-2 rounded">I. RINGKASAN MUTASI BARANG</h2>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-indigo-600 text-white text-[10px]">
                        <th class="p-2 border border-indigo-600">SKU</th>
                        <th class="p-2 border border-indigo-600">NAMA ITEM</th>
                        <th class="p-2 border border-indigo-600 text-center">AWAL</th>
                        <th class="p-2 border border-indigo-600 text-center">MASUK</th>
                        <th class="p-2 border border-indigo-600 text-center">KELUAR</th>
                        <th class="p-2 border border-indigo-600 text-center">AKHIR</th>
                    </tr>
                </thead>
                <tbody class="text-[10px]">
                    <template x-for="item in reportDataSummary">
                        <tr class="border-b border-slate-100">
                            <td class="p-2 font-bold text-slate-600" x-text="item[0]"></td>
                            <td class="p-2 text-slate-800" x-text="item[1]"></td>
                            <td class="p-2 text-center" x-text="item[2]"></td>
                            <td class="p-2 text-center text-emerald-600 font-bold" x-text="item[3]"></td>
                            <td class="p-2 text-center text-rose-600 font-bold" x-text="item[4]"></td>
                            <td class="p-2 text-center bg-slate-50 font-black" x-text="item[5]"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div class="mb-8">
            <h2 class="text-sm font-black text-slate-800 mb-4 bg-slate-100 p-2 rounded">II. LOG AKTIVITAS TRANSAKSI</h2>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-600 text-white text-[10px]">
                        <th class="p-2 border border-slate-600">TANGGAL</th>
                        <th class="p-2 border border-slate-600">SKU</th>
                        <th class="p-2 border border-slate-600">STATUS</th>
                        <th class="p-2 border border-slate-600 text-center">QTY</th>
                        <th class="p-2 border border-slate-600">LOKASI</th>
                        <th class="p-2 border border-slate-600">KETERANGAN</th>
                    </tr>
                </thead>
                <tbody class="text-[9px]">
                    <template x-for="trx in reportTrxDetails">
                        <tr class="border-b border-slate-100">
                            <td class="p-2 text-slate-600" x-text="trx.date.split(',')[0]"></td>
                            <td class="p-2 font-bold text-slate-800" x-text="trx.invNo"></td>
                            <td class="p-2 font-bold" :class="trx.type === 'in' ? 'text-emerald-600' : 'text-rose-600'" x-text="trx.type === 'in' ? 'MASUK' : 'KELUAR'"></td>
                            <td class="p-2 text-center font-bold" x-text="trx.type === 'in' ? '+' + trx.qty : '-' + trx.qty"></td>
                            <td class="p-2 text-slate-500" x-text="trx.location"></td>
                            <td class="p-2 text-slate-500 italic" x-text="trx.note || '-'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <div class="text-[8px] text-slate-400 flex justify-between items-center mt-10 pt-4 border-t border-dashed">
            <p x-text="'Dicetak pada: ' + new Date().toLocaleString('id-ID')"></p>
            <p>SmartStock System IT Version</p>
        </div>
    </div>

    <div x-show="openModal" x-cloak class="fixed inset-0 z-[60] flex items-center justify-center p-4 overflow-y-auto">
        <div x-show="openModal" x-transition @click="openModal = false" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        
        <div class="relative bg-white w-full max-lg rounded-[2.5rem] p-6 shadow-2xl z-10 gpu-layer modal-scroll-area" 
             x-transition:enter="transition ease-out duration-300 transform" 
             x-transition:enter-start="translate-y-full" 
             x-transition:enter-end="translate-y-0" 
             x-transition:leave="transition ease-in duration-200 transform" 
             x-transition:leave-start="translate-y-0" 
             x-transition:leave-end="translate-y-full">
            
            <button @click="openModal = false" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="w-10 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>

            <div class="flex bg-slate-100 p-1 rounded-2xl mb-5">
                <button @click="transactionType = 'in'; selectedItemId = 'new'" :class="transactionType === 'in' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'" class="flex-1 py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-down"></i> Masuk
                </button>
                <button @click="transactionType = 'out'; if(items.length > 0) { selectedItemId = items[0].id }" :class="transactionType === 'out' ? 'bg-white text-rose-600 shadow-sm' : 'text-slate-500'" class="flex-1 py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-up"></i> Keluar
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Tanggal</label>
                        <input type="date" x-model="transactionDate" class="w-full p-3 bg-slate-50 rounded-xl border-none font-bold text-sm ring-1 ring-slate-100 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Pilih Barang</label>
                        <select x-model="selectedItemId" class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm focus:ring-1 focus:ring-indigo-500 font-bold appearance-none ring-1 ring-slate-100">
                            <option value="new" x-show="transactionType === 'in'">+ Baru</option>
                            <template x-for="item in items" :key="item.id">
                                <option :value="item.id" x-text="item.name"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <div x-show="selectedItemId === 'new' && transactionType === 'in'" class="space-y-3 p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100/30" x-transition>
                    <input type="text" x-model="newItem.name" placeholder="Nama Barang Baru" class="w-full p-3 bg-white rounded-xl border-none text-sm font-bold shadow-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" x-model="newItem.location" placeholder="Lokasi" class="w-full p-3 bg-white rounded-xl border-none text-sm shadow-sm">
                        <input type="number" x-model.number="newItem.price" placeholder="Harga" class="w-full p-3 bg-white rounded-xl border-none text-sm shadow-sm">
                    </div>
                    <div class="flex gap-1 p-1 bg-white/50 rounded-lg">
                        <button @click="newItem.isPackage = false" :class="!newItem.isPackage ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'" class="flex-1 py-1.5 rounded-md text-[9px] font-bold uppercase transition-all">Pcs</button>
                        <button @click="newItem.isPackage = true" :class="newItem.isPackage ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'" class="flex-1 py-1.5 rounded-md text-[9px] font-bold uppercase transition-all">Pack</button>
                    </div>
                    <div x-show="newItem.isPackage" x-transition class="flex items-center gap-3 px-1">
                        <span class="text-[9px] font-bold text-indigo-400 uppercase">Isi/Pack:</span>
                        <input type="number" x-model.number="newItem.ratio" class="w-full p-2 bg-white rounded-lg border-none font-bold text-sm text-indigo-600 shadow-sm">
                    </div>
                </div>

                <div class="bg-indigo-600 p-4 rounded-[2rem] text-white">
                    <div class="flex items-center justify-between">
                        <button @click="trxQty > 0 ? trxQty-- : null" class="w-10 h-10 rounded-xl bg-white/20 hover:bg-white/30 flex items-center justify-center text-white active:scale-90 transition">
                            <i class="fas fa-minus"></i>
                        </button>
                        <div class="flex flex-col items-center">
                            <input type="number" x-model.number="trxQty" placeholder="0" class="w-24 bg-transparent border-none text-4xl font-black text-center text-white focus:ring-0 p-0">
                            <span class="text-[8px] font-bold opacity-60 uppercase tracking-tighter mt-1">Jumlah Unit</span>
                        </div>
                        <button @click="trxQty++" class="w-10 h-10 rounded-xl bg-white text-indigo-600 shadow-sm flex items-center justify-center active:scale-90 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="text-[9px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Keterangan</label>
                    <input type="text" x-model="trxNote" placeholder="Catatan transaksi..." class="w-full p-3 bg-slate-50 rounded-xl border-none text-sm font-medium ring-1 ring-slate-100 focus:ring-indigo-500">
                </div>

                <button @click="processTransaction()" :class="transactionType === 'in' ? 'bg-emerald-500 shadow-emerald-100' : 'bg-rose-500 shadow-rose-100'" class="w-full text-white py-4 rounded-[1.5rem] font-bold text-base shadow-xl mt-2 active:scale-95 transition transform">Simpan Transaksi</button>
            </div>
        </div>
    </div>

    <div x-show="customModal.show" x-cloak class="fixed inset-0 z-[100] flex items-center justify-center px-8">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="if(!customModal.isConfirm) customModal.show = false"></div>
        <div class="relative bg-white w-full max-sm rounded-[2.5rem] p-8 shadow-2xl text-center gpu-layer" x-transition:enter="transition scale-90 opacity-0" x-transition:enter-end="scale-100 opacity-100">
            <div class="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4" :class="customModal.type === 'error' ? 'bg-rose-100 text-rose-500' : 'bg-indigo-100 text-indigo-500'">
                <i class="fas" :class="customModal.type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'"></i>
            </div>
            <h3 class="font-black text-xl mb-2" x-text="customModal.title"></h3>
            <p class="text-slate-500 text-sm mb-6" x-text="customModal.message"></p>
            <div class="flex gap-3">
                <template x-if="customModal.isConfirm">
                    <button @click="customModal.show = false" class="flex-1 p-4 bg-slate-100 rounded-2xl font-bold text-slate-500">Batal</button>
                </template>
                <button @click="customModal.onConfirm(); customModal.show = false" class="flex-1 p-4 bg-indigo-600 rounded-2xl font-bold text-white shadow-lg" x-text="customModal.btnText"></button>
            </div>
        </div>
    </div>

    <script>
        function inventoryApp() {
            return {
                currentTab: 'dashboard',
                tabsOrder: ['dashboard', 'barang', 'laporan', 'settings'],
                openModal: false,
                search: '',
                items: [],
                transactions: [],
                transactionDate: new Date().toISOString().split('T')[0],
                config: { prefix: 'SKU-' + new Date().getFullYear() + '-', lastIteration: 0, padding: 3, zoomScale: 100 },
                newItem: { name: '', price: '', location: '', ratio: 1, isPackage: false },
                trxQty: '',
                trxNote: '',
                showLimit: 10,
                reportLimit: 12, 
                selectedItemId: 'new',
                transactionType: 'in',
                customModal: { show: false, title: '', message: '', type: 'info', isConfirm: false, btnText: 'OK', onConfirm: () => {} },
                isSwiping: false,

                showImagePreview: false,
                previewImageData: '',
                activeReportName: '',
                reportDataSummary: [],
                reportTrxDetails: [],

                showAlert(title, message, type = 'info') {
                    this.customModal = { show: true, title, message, type, isConfirm: false, btnText: 'OK', onConfirm: () => {} };
                },

                showConfirm(title, message, callback) {
                    this.customModal = { show: true, title, message, type: 'info', isConfirm: true, btnText: 'Lanjutkan', onConfirm: callback };
                },

                init() {
                    this.items = JSON.parse(localStorage.getItem('ss_items_v5') || '[]');
                    this.transactions = JSON.parse(localStorage.getItem('ss_transactions_v5') || '[]');
                    this.config = JSON.parse(localStorage.getItem('ss_config_v5') || JSON.stringify(this.config));

                    this.updateZoom();

                    this.$watch('currentTab', () => {
                        window.scrollTo({ top: 0, behavior: 'instant' });
                    });

                    const mainElement = document.querySelector('main');
                    const mc = new Hammer(mainElement);
                    mc.get('swipe').set({ direction: Hammer.DIRECTION_HORIZONTAL, threshold: 20, velocity: 0.3 });

                    mc.on("swipeleft", () => {
                        if (this.isSwiping) return;
                        let currentIndex = this.tabsOrder.indexOf(this.currentTab);
                        if (currentIndex < this.tabsOrder.length - 1) {
                            this.currentTab = this.tabsOrder[currentIndex + 1];
                            this.lockSwipe();
                        }
                    });

                    mc.on("swiperight", () => {
                        if (this.isSwiping) return;
                        let currentIndex = this.tabsOrder.indexOf(this.currentTab);
                        if (currentIndex > 0) {
                            this.currentTab = this.tabsOrder[currentIndex - 1];
                            this.lockSwipe();
                        }
                    });
                },

                updateZoom() {
                    document.body.style.zoom = (this.config.zoomScale || 100) + '%';
                    this.save();
                },

                lockSwipe() {
                    this.isSwiping = true;
                    setTimeout(() => {
                        this.isSwiping = false;
                    }, 300);
                },

                save() {
                    localStorage.setItem('ss_items_v5', JSON.stringify(this.items));
                    localStorage.setItem('ss_transactions_v5', JSON.stringify(this.transactions));
                    localStorage.setItem('ss_config_v5', JSON.stringify(this.config));
                },

                generatePreview() {
                    return this.config.prefix + (this.config.lastIteration + 1).toString().padStart(this.config.padding, '0');
                },

                processTransaction() {
                    if (this.trxQty === '' || this.trxQty <= 0 || !Number.isInteger(Number(this.trxQty))) {
                        this.showAlert("Error", "Jumlah unit harus berupa angka bulat lebih dari 0", "error");
                        return;
                    }

                    if (!this.transactionDate) {
                        this.showAlert("Error", "Tanggal transaksi harus diisi", "error");
                        return;
                    }

                    let targetItem;

                    if (this.selectedItemId === 'new' && this.transactionType === 'in') {
                        this.newItem.name = this.newItem.name.trim();
                        this.newItem.location = this.newItem.location.trim();

                        if (!this.newItem.name || this.newItem.name.length < 3) {
                            this.showAlert("Error", "Nama barang minimal 3 karakter", "error");
                            return;
                        }

                        if (this.newItem.price < 0) {
                            this.showAlert("Error", "Harga tidak boleh negatif", "error");
                            return;
                        }

                        if (this.newItem.isPackage && (this.newItem.ratio <= 0 || !this.newItem.ratio)) {
                            this.showAlert("Error", "Isi per kemasan harus lebih dari 0", "error");
                            return;
                        }

                        const isDuplicate = this.items.some(i => i.name.toLowerCase() === this.newItem.name.toLowerCase());
                        if (isDuplicate) {
                            this.showAlert("Peringatan", "Barang dengan nama ini sudah ada di sistem", "error");
                            return;
                        }

                        this.config.lastIteration++;
                        
                        let finalQty = parseInt(this.trxQty);
                        if (this.newItem.isPackage && this.newItem.ratio > 1) {
                            finalQty = finalQty * parseInt(this.newItem.ratio);
                        }

                        targetItem = { 
                            id: Date.now(), 
                            invNo: this.generatePreview(), 
                            name: this.newItem.name, 
                            location: this.newItem.location || 'Gudang Utama', 
                            stock: 0, 
                            price: parseInt(this.newItem.price || 0) 
                        };
                        this.items.push(targetItem);
                        this.trxQty = finalQty;
                    } else {
                        targetItem = this.items.find(i => i.id == this.selectedItemId);
                    }

                    if (!targetItem) {
                        this.showAlert("Error", "Item tidak ditemukan", "error");
                        return;
                    }

                    if (this.transactionType === 'in') {
                        targetItem.stock += parseInt(this.trxQty);
                    } else {
                        if (targetItem.stock < this.trxQty) {
                            this.showAlert("Gagal", `Stok tidak mencukupi! Stok saat ini: ${targetItem.stock}`, "error");
                            return;
                        }
                        targetItem.stock -= parseInt(this.trxQty);
                    }

                    const customDate = new Date(this.transactionDate);
                    const formattedDate = customDate.toLocaleString('id-ID', { dateStyle: 'medium' }) + ', ' + new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                    this.transactions.unshift({ 
                        id: Date.now(), 
                        itemName: targetItem.name, 
                        invNo: targetItem.invNo, 
                        type: this.transactionType, 
                        qty: this.trxQty, 
                        note: this.trxNote,
                        location: targetItem.location,
                        date: formattedDate,
                        timestamp: customDate.toISOString()
                    });
                    
                    this.transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    this.save();
                    this.openModal = false;
                    this.resetForms();
                    this.showAlert("Sukses", "Transaksi berhasil disimpan");
                },

                deleteTransaction(trxId) {
                    this.showConfirm('Hapus Transaksi?', 'Stok barang akan dikembalikan ke kondisi sebelumnya.', () => {
                        const trxIndex = this.transactions.findIndex(t => t.id === trxId);
                        if (trxIndex === -1) return;

                        const trx = this.transactions[trxIndex];
                        const targetItem = this.items.find(i => i.invNo === trx.invNo);

                        if (targetItem) {
                            if (trx.type === 'in') {
                                targetItem.stock -= parseInt(trx.qty);
                            } else {
                                targetItem.stock += parseInt(trx.qty);
                            }
                        }

                        this.transactions.splice(trxIndex, 1);
                        this.save();
                        this.showAlert("Sukses", "Transaksi telah dihapus");
                    });
                },

                deleteItem(itemId) {
                    const itemIndex = this.items.findIndex(i => i.id === itemId);
                    if (itemIndex === -1) return;

                    const item = this.items[itemIndex];

                    if (item.stock > 0) {
                        this.showAlert("Gagal Menghapus", `Barang "${item.name}" masih memiliki stok (${item.stock}). Kosongkan stok terlebih dahulu melalui transaksi keluar.`, "error");
                        return;
                    }

                    this.showConfirm('Hapus Barang?', `Apakah Anda yakin ingin menghapus "${item.name}" dari sistem?`, () => {
                        this.items.splice(itemIndex, 1);
                        this.transactions = this.transactions.filter(t => t.invNo !== item.invNo);
                        this.save();
                        this.showAlert("Sukses", "Barang telah dihapus dari sistem");
                    });
                },

                getMonthlyReports() {
                    const groups = {};
                    this.transactions.forEach(t => {
                        const date = new Date(t.timestamp);
                        const month = date.getMonth();
                        const year = date.getFullYear();
                        const key = `${month}-${year}`;
                        if (!groups[key]) {
                            groups[key] = {
                                key,
                                month,
                                year,
                                monthName: date.toLocaleString('id-ID', { month: 'long', year: 'numeric' }),
                                count: 0
                            };
                        }
                        groups[key].count++;
                    });
                    return Object.values(groups).sort((a, b) => (b.year - a.year) || (b.month - a.month));
                },

                previewImage(report) {
                    this.showImagePreview = true;
                    this.previewImageData = '';
                    this.activeReportName = report.monthName;

                    const targetStartDate = new Date(report.year, report.month, 1);
                    const targetEndDate = new Date(report.year, report.month + 1, 0, 23, 59, 59);

                    this.reportDataSummary = this.items.map(item => {
                        let saldoLalu = 0, masuk = 0, keluar = 0;
                        this.transactions.forEach(t => {
                            const tDate = new Date(t.timestamp);
                            if (t.invNo === item.invNo) {
                                if (tDate < targetStartDate) {
                                    if (t.type === 'in') saldoLalu += parseInt(t.qty);
                                    else saldoLalu -= parseInt(t.qty);
                                } else if (tDate <= targetEndDate) {
                                    if (t.type === 'in') masuk += parseInt(t.qty);
                                    else keluar += parseInt(t.qty);
                                }
                            }
                        });
                        return [
                            item.invNo, 
                            item.name.toUpperCase(), 
                            saldoLalu.toLocaleString('id-ID'), 
                            masuk.toLocaleString('id-ID'), 
                            keluar.toLocaleString('id-ID'), 
                            (saldoLalu + masuk - keluar).toLocaleString('id-ID')
                        ];
                    });

                    this.reportTrxDetails = this.transactions
                        .filter(t => {
                            const tDate = new Date(t.timestamp);
                            return tDate >= targetStartDate && tDate <= targetEndDate;
                        })
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    this.$nextTick(() => {
                        setTimeout(() => {
                            html2canvas(document.querySelector("#report-template"), {
                                scale: 2,
                                logging: false,
                                useCORS: true
                            }).then(canvas => {
                                this.previewImageData = canvas.toDataURL("image/png");
                            });
                        }, 500);
                    });
                },

                downloadPNG() {
                    const base64Data = this.previewImageData;
                    if (!base64Data) return;

                    const byteString = atob(base64Data.split(',')[1]);
                    const mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    const blob = new Blob([ab], { type: mimeString });

                    const fileName = `Report_${this.activeReportName.replace(/\s+/g, '_')}.png`;
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    link.href = url;
                    link.download = fileName;
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    }, 100);

                    this.showAlert("Sukses", "Gambar sedang diunduh.");
                },

                downloadMonthlyPDF(month, year, monthName) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const targetStartDate = new Date(year, month, 1);
                    const targetEndDate = new Date(year, month + 1, 0, 23, 59, 59);
                    doc.setFillColor(79, 70, 229); 
                    doc.rect(0, 0, 210, 30, 'F');
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(18);
                    doc.setTextColor(255, 255, 255);
                    doc.text('SMARTSTOCK', 12, 12);
                    doc.setFontSize(9);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(199, 210, 254);
                    doc.text('Laporan Inventaris Digital Otomatis', 12, 18);
                    doc.setFillColor(255, 255, 255, 0.15);
                    doc.roundedRect(145, 8, 52, 14, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.text('PERIODE:', 148, 13);
                    doc.setFontSize(10);
                    doc.text(monthName.toUpperCase(), 148, 19);
                    doc.setTextColor(120);
                    doc.setFontSize(7);
                    doc.text(`Dicetak: ${new Date().toLocaleString('id-ID')}`, 12, 35);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(30, 41, 59);
                    doc.text('I. RINGKASAN MUTASI BARANG', 12, 42);
                    const itemSummaries = this.items.map(item => {
                        let saldoLalu = 0, masuk = 0, keluar = 0;
                        this.transactions.forEach(t => {
                            const tDate = new Date(t.timestamp);
                            if (t.invNo === item.invNo) {
                                if (tDate < targetStartDate) {
                                    if (t.type === 'in') saldoLalu += parseInt(t.qty);
                                    else saldoLalu -= parseInt(t.qty);
                                } else if (tDate <= targetEndDate) {
                                    if (t.type === 'in') masuk += parseInt(t.qty);
                                    else keluar += parseInt(t.qty);
                                }
                            }
                        });
                        return [
                            item.invNo, 
                            item.name.toUpperCase(), 
                            saldoLalu.toLocaleString('id-ID'), 
                            masuk.toLocaleString('id-ID'), 
                            keluar.toLocaleString('id-ID'), 
                            (saldoLalu + masuk - keluar).toLocaleString('id-ID')
                        ];
                    });
                    doc.autoTable({
                        startY: 45,
                        head: [['SKU', 'NAMA ITEM', 'AWAL', 'MASUK', 'KELUAR', 'AKHIR']],
                        body: itemSummaries,
                        theme: 'striped',
                        headStyles: { fillColor: [79, 70, 229], halign: 'center', fontSize: 8 },
                        columnStyles: {
                            0: { fontStyle: 'bold', cellWidth: 22 },
                            1: { cellWidth: 'auto' },
                            2: { halign: 'center' },
                            3: { halign: 'center', textColor: [16, 185, 129] },
                            4: { halign: 'center', textColor: [244, 63, 94] },
                            5: { halign: 'center', fontStyle: 'bold', fillColor: [248, 250, 252] }
                        },
                        styles: { fontSize: 7.5, cellPadding: 1.5, lineColor: [241, 245, 249], lineWidth: 0.1 },
                        margin: { left: 12, right: 12 }
                    });
                    const nextY = doc.lastAutoTable.finalY + 8;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text('II. LOG AKTIVITAS TRANSAKSI', 12, nextY);
                    const monthlyTrx = this.transactions
                        .filter(t => {
                            const tDate = new Date(t.timestamp);
                            return tDate >= targetStartDate && tDate <= targetEndDate;
                        })
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                        .map(t => [
                            t.date.split(',')[0],
                            t.invNo,
                            t.itemName,
                            t.type === 'in' ? 'MASUK' : 'KELUAR',
                            t.type === 'in' ? `+${t.qty}` : `-${t.qty}`,
                            t.note || '-'
                        ]);
                    doc.autoTable({
                        startY: nextY + 3,
                        head: [['TANGGAL', 'SKU', 'NAMA BARANG', 'STATUS', 'QTY', 'KETERANGAN']],
                        body: monthlyTrx,
                        theme: 'grid',
                        headStyles: { fillColor: [71, 85, 105], halign: 'center', fontSize: 8 },
                        didParseCell: function(data) {
                            if (data.section === 'body') {
                                if (data.column.index === 3) {
                                    const val = data.cell.raw;
                                    data.cell.styles.fontStyle = 'bold';
                                    data.cell.styles.textColor = (val === 'MASUK') ? [16, 185, 129] : [244, 63, 94];
                                }
                                if (data.column.index === 4) {
                                    data.cell.styles.fontStyle = 'bold';
                                    data.cell.styles.halign = 'center';
                                }
                            }
                        },
                        styles: { fontSize: 7, cellPadding: 1.2 },
                        margin: { left: 12, right: 12 }
                    });
                    const pageCount = doc.internal.getNumberOfPages();
                    for(let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(7);
                        doc.setTextColor(160);
                        doc.text(`SmartStock - Halaman ${i} / ${pageCount}`, 105, 290, { align: 'center' });
                    }
                    
                    const safeFileName = `Laporan_${monthName.split(' ').join('_')}.pdf`;
                    const pdfOutput = doc.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfOutput);
                    const downloadLink = document.createElement("a");
                    downloadLink.href = pdfUrl;
                    downloadLink.download = safeFileName;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    setTimeout(() => URL.revokeObjectURL(pdfUrl), 100);
                },

                exportData() {
                    const data = { items: this.items, transactions: this.transactions, config: this.config };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                },

                importData(event) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = JSON.parse(e.target.result);
                        this.items = data.items;
                        this.transactions = data.transactions;
                        this.config = data.config;
                        this.save();
                        location.reload();
                    };
                    reader.readAsText(event.target.files[0]);
                },

                resetForms() { 
                    this.trxQty = ''; 
                    this.trxNote = '';
                    this.transactionDate = new Date().toISOString().split('T')[0];
                    this.newItem = { name: '', price: '', location: '', ratio: 1, isPackage: false }; 
                    if (this.items.length > 0) this.selectedItemId = this.items[0].id; 
                },

                resetApp() { localStorage.clear(); location.reload(); },
                totalStock() { return this.items.reduce((sum, item) => sum + item.stock, 0); },
                formatNumber(num) { return new Intl.NumberFormat('id-ID').format(num); },
                get filteredItems() {
                    const s = this.search.toLowerCase();
                    return this.items.filter(i => 
                        i.name.toLowerCase().includes(s) || 
                        i.invNo.toLowerCase().includes(s) || 
                        (i.location && i.location.toLowerCase().includes(s))
                    );
                }
            }
        }
    </script>
</body>
</html>
