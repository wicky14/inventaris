<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartStock Pro V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        [x-cloak] { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); }
        .safe-area-bottom { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .fab-container { filter: drop-shadow(0 10px 15px rgba(79, 70, 229, 0.3)); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-hidden" x-data="inventoryApp()" x-init="init()">

    <header class="fixed top-0 w-full glass z-40 border-b border-slate-200 px-6 py-5 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-indigo-600">SmartStock <span class="text-[10px] bg-indigo-600 text-white px-2 py-0.5 rounded-full ml-1">V5</span></h1>
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest" x-text="currentTab"></p>
        </div>
        <div class="flex items-center gap-3">
             <button @click="generateMonthlyPDF()" class="text-emerald-600 bg-emerald-50 w-9 h-9 rounded-xl flex items-center justify-center">
                <i class="fas fa-file-pdf text-sm"></i>
            </button>
            <span class="text-[10px] font-mono font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">Next: <span class="text-indigo-600" x-text="generatePreview()"></span></span>
        </div>
    </header>

    <div class="fixed bottom-28 right-6 z-50 fab-container" x-show="currentTab !== 'settings'" x-transition>
        <button @click="openModal = true; selectedItemId = 'new'; transactionType = 'in'; resetForms()" class="bg-indigo-600 text-white w-16 h-16 rounded-2xl shadow-2xl flex items-center justify-center active:scale-90 transition transform">
            <i class="fas fa-plus text-2xl"></i>
        </button>
    </div>

    <main class="h-screen overflow-y-auto pt-24 pb-40 px-6">
        <div x-show="currentTab === 'dashboard'" x-transition>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-indigo-600 p-6 rounded-[2.5rem] text-white shadow-xl shadow-indigo-100">
                    <p class="text-[10px] font-bold opacity-70 uppercase tracking-wider">Total Unit</p>
                    <p class="text-3xl font-black mt-1" x-text="totalStock()"></p>
                </div>
                <div @click="currentTab = 'barang'" class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Jenis Barang</p>
                    <p class="text-3xl font-black text-slate-800 mt-1" x-text="items.length"></p>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h2 class="font-extrabold text-slate-800">Riwayat Transaksi</h2>
                <span class="text-[10px] font-bold text-slate-400 uppercase" x-text="transactions.length + ' Total'"></span>
            </div>
            
            <div class="space-y-3">
                <template x-for="(trx, index) in transactions.slice(0, showLimit)" :key="trx.id">
                    <div class="bg-white p-4 rounded-3xl flex items-center justify-between border border-slate-50 shadow-sm">
                        <div class="flex items-center gap-4">
                            <div :class="trx.type === 'in' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'" 
                                 class="w-12 h-12 rounded-2xl flex items-center justify-center text-lg">
                                <i :class="trx.type === 'in' ? 'fas fa-arrow-down' : 'fas fa-arrow-up'"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm text-slate-800" x-text="trx.itemName"></p>
                                <p class="text-[10px] text-slate-400 font-medium" x-text="trx.date"></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p :class="trx.type === 'in' ? 'text-emerald-600' : 'text-rose-600'" class="font-black text-lg" x-text="(trx.type === 'in' ? '+' : '-') + trx.qty"></p>
                            <p class="text-[9px] font-mono text-slate-300" x-text="trx.location"></p>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="currentTab === 'barang'" x-transition>
            <div class="relative mb-6">
                <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" x-model="search" placeholder="Cari Kode, Nama, Lokasi..." 
                    class="w-full pl-14 pr-6 py-5 rounded-[2rem] bg-white border-none shadow-sm focus:ring-2 focus:ring-indigo-500">
            </div>

            <div class="space-y-4">
                <template x-for="item in filteredItems" :key="item.id">
                    <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-slate-50 flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex gap-2 items-center mb-1">
                                <span class="text-[9px] font-mono font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded" x-text="item.invNo"></span>
                                <span class="text-[9px] font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded uppercase" x-text="item.location"></span>
                            </div>
                            <h3 class="font-bold text-slate-800 text-lg" x-text="item.name"></h3>
                            <p class="text-sm text-slate-400 font-semibold" x-text="'Rp ' + formatNumber(item.price)"></p>
                        </div>
                        <div class="flex items-center gap-4 bg-slate-50 px-4 py-3 rounded-[1.5rem] border border-slate-100">
                            <div class="text-center">
                                <span class="text-[9px] font-bold text-slate-400 block leading-none mb-1">STOK</span>
                                <span class="text-2xl font-black text-slate-700" x-text="item.stock"></span>
                            </div>
                            <button @click="openRenameModal(item)" class="text-indigo-400 hover:text-indigo-600 transition p-2">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="currentTab === 'settings'" x-transition>
            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100 space-y-6">
                <h2 class="font-black text-2xl text-slate-800">Sistem & Data</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button @click="exportData()" class="flex flex-col items-center p-4 bg-indigo-50 text-indigo-600 rounded-3xl gap-2">
                        <i class="fas fa-file-download text-xl"></i>
                        <span class="text-[10px] font-bold uppercase">Export Backup</span>
                    </button>
                    <label class="flex flex-col items-center p-4 bg-slate-50 text-slate-600 rounded-3xl gap-2 cursor-pointer">
                        <i class="fas fa-file-upload text-xl"></i>
                        <span class="text-[10px] font-bold uppercase">Import Data</span>
                        <input type="file" @change="importData($event)" class="hidden" accept=".json">
                    </label>
                </div>
                <div class="pt-6 border-t border-slate-100">
                    <button @click="showConfirm('Reset Data?', 'Semua data akan dihapus permanen!', () => resetApp())" class="w-full p-5 text-rose-500 font-bold text-sm bg-rose-50 rounded-2xl active:bg-rose-100 transition">Reset Semua Data</button>
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 w-full glass border-t border-slate-200 px-10 pt-5 pb-10 z-40 flex justify-between safe-area-bottom">
        <button @click="currentTab = 'dashboard'" :class="currentTab === 'dashboard' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1.5 transition-colors">
            <i class="fas fa-house-chimney text-xl"></i>
            <span class="text-[10px] font-bold tracking-wide">Home</span>
        </button>
        <button @click="currentTab = 'barang'" :class="currentTab === 'barang' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1.5 transition-colors">
            <i class="fas fa-box-open text-xl"></i>
            <span class="text-[10px] font-bold tracking-wide">Stock</span>
        </button>
        <button @click="currentTab = 'settings'" :class="currentTab === 'settings' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center gap-1.5 transition-colors">
            <i class="fas fa-sliders text-xl"></i>
            <span class="text-[10px] font-bold tracking-wide">Sistem</span>
        </button>
    </nav>

    <div x-show="openModal" x-cloak class="fixed inset-0 z-[60] flex items-end px-0">
        <div x-show="openModal" x-transition @click="openModal = false" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="relative bg-white w-full rounded-t-[3rem] p-8 pb-14 shadow-2xl z-10" x-transition:enter="transition translate-y-full" x-transition:enter-end="translate-y-0" x-transition:leave="transition translate-y-0" x-transition:leave-end="translate-y-full">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
            
            <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-8">
                <button @click="transactionType = 'in'; selectedItemId = 'new'" :class="transactionType === 'in' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-down"></i> Masuk
                </button>
                <button @click="transactionType = 'out'; if(items.length > 0) { selectedItemId = items[0].id }" :class="transactionType === 'out' ? 'bg-white text-rose-600 shadow-sm' : 'text-slate-500'" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-arrow-up"></i> Keluar
                </button>
            </div>

            <div class="space-y-5">
                <div class="relative">
                    <select x-model="selectedItemId" class="w-full p-5 bg-slate-50 rounded-2xl border-none focus:ring-2 focus:ring-indigo-500 font-bold appearance-none">
                        <option value="new" x-show="transactionType === 'in'">+ Tambah Barang Baru</option>
                        <template x-for="item in items" :key="item.id">
                            <option :value="item.id" x-text="item.name + ' (' + item.invNo + ')'"></option>
                        </template>
                    </select>
                </div>

                <div x-show="selectedItemId === 'new' && transactionType === 'in'" class="space-y-4" x-transition>
                    <input type="text" x-model="newItem.name" placeholder="Nama Barang Baru" class="w-full p-5 bg-slate-50 rounded-2xl border-none font-bold ring-2 ring-indigo-100">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" x-model="newItem.location" placeholder="Lokasi" class="w-full p-5 bg-slate-50 rounded-2xl border-none">
                        <input type="number" x-model.number="newItem.price" placeholder="Harga" class="w-full p-5 bg-slate-50 rounded-2xl border-none">
                    </div>
                </div>

                <div class="bg-indigo-50/50 p-6 rounded-[2.5rem]">
                    <div class="flex items-center justify-between">
                        <button @click="trxQty > 0 ? trxQty-- : null" class="w-12 h-12 rounded-2xl bg-white shadow-sm flex items-center justify-center text-indigo-600 active:scale-90 transition">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" x-model.number="trxQty" placeholder="0" class="w-1/2 bg-transparent border-none text-4xl font-black text-center text-indigo-600 focus:ring-0">
                        <button @click="trxQty++" class="w-12 h-12 rounded-2xl bg-indigo-600 shadow-lg flex items-center justify-center text-white active:scale-90 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <button @click="processTransaction()" :class="transactionType === 'in' ? 'bg-emerald-500 shadow-emerald-100' : 'bg-rose-500 shadow-rose-100'" class="w-full text-white py-6 rounded-[2rem] font-bold text-lg shadow-xl mt-4 active:scale-95 transition transform">Simpan Transaksi</button>
            </div>
        </div>
    </div>

    <div x-show="renameModal.show" x-cloak class="fixed inset-0 z-[70] flex items-center justify-center px-8">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="renameModal.show = false"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl text-center" x-transition>
            <h3 class="font-black text-xl mb-4">Ganti Nama Barang</h3>
            <input type="text" x-model="renameModal.newName" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold focus:ring-2 focus:ring-indigo-500 mb-6 text-center">
            <div class="flex gap-3">
                <button @click="renameModal.show = false" class="flex-1 p-4 bg-slate-100 rounded-2xl font-bold text-slate-500">Batal</button>
                <button @click="confirmRename()" class="flex-1 p-4 bg-indigo-600 rounded-2xl font-bold text-white shadow-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div x-show="customModal.show" x-cloak class="fixed inset-0 z-[100] flex items-center justify-center px-8">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="if(!customModal.isConfirm) customModal.show = false"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl text-center" x-transition:enter="transition scale-90 opacity-0" x-transition:enter-end="scale-100 opacity-100">
            <div class="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4" :class="customModal.type === 'error' ? 'bg-rose-100 text-rose-500' : 'bg-indigo-100 text-indigo-500'">
                <i class="fas" :class="customModal.type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'"></i>
            </div>
            <h3 class="font-black text-xl mb-2" x-text="customModal.title"></h3>
            <p class="text-slate-500 text-sm mb-6" x-text="customModal.message"></p>
            <div class="flex gap-3">
                <template x-if="customModal.isConfirm">
                    <button @click="customModal.show = false" class="flex-1 p-4 bg-slate-100 rounded-2xl font-bold text-slate-500">Batal</button>
                </template>
                <button @click="customModal.onConfirm(); customModal.show = false" class="flex-1 p-4 bg-indigo-600 rounded-2xl font-bold text-white shadow-lg" x-text="customModal.btnText"></button>
            </div>
        </div>
    </div>

    <script>
        function inventoryApp() {
            return {
                currentTab: 'dashboard',
                openModal: false,
                search: '',
                items: [],
                transactions: [],
                config: { prefix: 'SKU-' + new Date().getFullYear() + '-', lastIteration: 0, padding: 3 },
                newItem: { name: '', price: '', location: '' },
                trxQty: '',
                showLimit: 20,
                selectedItemId: 'new',
                transactionType: 'in',

                // Logic Modal Rename (Pengganti Prompt)
                renameModal: {
                    show: false,
                    itemId: null,
                    newName: ''
                },

                // Logic Modal Custom
                customModal: {
                    show: false,
                    title: '',
                    message: '',
                    type: 'info',
                    isConfirm: false,
                    btnText: 'OK',
                    onConfirm: () => {}
                },

                showAlert(title, message, type = 'info') {
                    this.customModal = { show: true, title, message, type, isConfirm: false, btnText: 'OK', onConfirm: () => {} };
                },

                showConfirm(title, message, callback) {
                    this.customModal = { show: true, title, message, type: 'info', isConfirm: true, btnText: 'Lanjutkan', onConfirm: callback };
                },

                init() {
                    this.items = JSON.parse(localStorage.getItem('ss_items_v5') || '[]');
                    this.transactions = JSON.parse(localStorage.getItem('ss_transactions_v5') || '[]');
                    this.config = JSON.parse(localStorage.getItem('ss_config_v5') || JSON.stringify(this.config));
                },

                save() {
                    localStorage.setItem('ss_items_v5', JSON.stringify(this.items));
                    localStorage.setItem('ss_transactions_v5', JSON.stringify(this.transactions));
                    localStorage.setItem('ss_config_v5', JSON.stringify(this.config));
                },

                generatePreview() {
                    return this.config.prefix + (this.config.lastIteration + 1).toString().padStart(this.config.padding, '0');
                },

                processTransaction() {
                    if (this.trxQty <= 0) {
                        this.showAlert("Error", "Jumlah harus lebih dari 0", "error");
                        return;
                    }
                    let targetItem;

                    if (this.selectedItemId === 'new' && this.transactionType === 'in') {
                        if (!this.newItem.name) {
                            this.showAlert("Error", "Nama barang wajib diisi", "error");
                            return;
                        }
                        this.config.lastIteration++;
                        targetItem = { 
                            id: Date.now(), 
                            invNo: this.generatePreview(), 
                            name: this.newItem.name, 
                            location: this.newItem.location || 'Gudang Utama', 
                            stock: 0, 
                            price: parseInt(this.newItem.price || 0) 
                        };
                        this.items.push(targetItem);
                    } else {
                        targetItem = this.items.find(i => i.id == this.selectedItemId);
                    }

                    if (!targetItem) return;
                    if (this.transactionType === 'in') {
                        targetItem.stock += parseInt(this.trxQty);
                    } else {
                        if (targetItem.stock < this.trxQty) {
                            this.showAlert("Gagal", "Stok tidak mencukupi!", "error");
                            return;
                        }
                        targetItem.stock -= parseInt(this.trxQty);
                    }

                    this.transactions.unshift({ 
                        id: Date.now(), 
                        itemName: targetItem.name, 
                        invNo: targetItem.invNo, 
                        location: targetItem.location, 
                        type: this.transactionType, 
                        qty: this.trxQty, 
                        date: new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }),
                        timestamp: new Date().toISOString()
                    });
                    
                    this.save();
                    this.openModal = false;
                    this.resetForms();
                    this.showAlert("Sukses", "Transaksi berhasil disimpan");
                },

                // Fungsi Pengganti Prompt untuk Ganti Nama
                openRenameModal(item) {
                    this.renameModal.itemId = item.id;
                    this.renameModal.newName = item.name;
                    this.renameModal.show = true;
                },

                confirmRename() {
                    if (this.renameModal.newName.trim() === "") {
                        this.showAlert("Error", "Nama tidak boleh kosong", "error");
                        return;
                    }
                    const item = this.items.find(i => i.id === this.renameModal.itemId);
                    if (item) {
                        const oldName = item.name;
                        item.name = this.renameModal.newName;
                        
                        // Sinkronisasi riwayat agar laporan tetap benar
                        this.transactions.forEach(t => {
                            if(t.invNo === item.invNo) t.itemName = item.name;
                        });

                        this.save();
                        this.renameModal.show = false;
                        this.showAlert("Berhasil", `Nama "${oldName}" diubah menjadi "${item.name}"`);
                    }
                },

                generateMonthlyPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const now = new Date();
                    const bulanIni = now.toLocaleString('id-ID', { month: 'long', year: 'numeric' });

                    doc.setFontSize(18);
                    doc.text('Laporan Inventaris Bulanan', 14, 20);
                    doc.setFontSize(11);
                    doc.text(`Periode: ${bulanIni}`, 14, 28);

                    const trxBulanIni = this.transactions.filter(t => {
                        const date = new Date(t.timestamp || t.date);
                        return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                    });

                    const tableData = trxBulanIni.map(t => [
                        t.date,
                        t.itemName,
                        t.type === 'in' ? 'MASUK' : 'KELUAR',
                        t.qty,
                        t.location
                    ]);

                    doc.autoTable({
                        startY: 35,
                        head: [['Tanggal', 'Nama Barang', 'Tipe', 'Qty', 'Lokasi']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [79, 70, 229] }
                    });

                    this.showConfirm("Kirim WhatsApp?", "Laporan PDF telah dibuat. Kirim ringkasan ke WhatsApp?", () => {
                        const text = `*LAPORAN INVENTARIS - ${bulanIni}*\n\nTotal Transaksi: ${trxBulanIni.length}\nSilakan cek file PDF yang diunduh.`;
                        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                        doc.save(`Laporan_${bulanIni.replace(' ', '_')}.pdf`);
                    });
                },

                exportData() {
                    const fullData = { items: this.items, transactions: this.transactions, config: this.config };
                    const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `backup_stock_${new Date().toISOString().slice(0,10)}.json`;
                    link.click();
                    this.showAlert("Berhasil", "Data berhasil diekspor ke file JSON");
                },

                importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(data.items && data.transactions) {
                                this.items = data.items;
                                this.transactions = data.transactions;
                                this.config = data.config || this.config;
                                this.save();
                                this.showAlert("Sukses", "Data berhasil diimport. Aplikasi akan dimuat ulang", "info");
                                setTimeout(() => location.reload(), 1500);
                            }
                        } catch (err) { this.showAlert("Gagal", "Format file tidak valid", "error"); }
                    };
                    reader.readAsText(file);
                },

                resetForms() { 
                    this.trxQty = ''; 
                    this.newItem = { name: '', price: '', location: '' }; 
                    if (this.items.length > 0) this.selectedItemId = this.items[0].id; 
                },

                resetApp() { 
                    localStorage.clear(); 
                    location.reload(); 
                },

                totalStock() { return this.items.reduce((sum, item) => sum + item.stock, 0); },
                formatNumber(num) { return new Intl.NumberFormat('id-ID').format(num); },
                get filteredItems() {
                    const s = this.search.toLowerCase();
                    return this.items.filter(i => i.name.toLowerCase().includes(s) || i.invNo.toLowerCase().includes(s) || i.location.toLowerCase().includes(s));
                }
            }
        }
    </script>
</body>
</html>
